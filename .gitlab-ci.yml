stages:
  - prepare
  - lint
  - build
  - deploy
  - release

workflow:
  auto_cancel:
    on_new_commit: conservative

include:
  - project: "infrastructure/ci-templates"
    ref: develop
    file: "frontend/next-standalone-build.gitlab-ci.yml"

  
deploy develop:
  stage: deploy
  script:
    - docker login -u $ROOT_USER -p $ROOT_USER_TOKEN $CI_REGISTRY
    - docker stack deploy --with-registry-auth --resolve-image=always -c docker-compose.develop.yml $STACK_NAME_DEV
  rules:
    - if: $CI_COMMIT_BRANCH == "develop" && $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_STATE == "merged"
    - if: $CI_COMMIT_BRANCH == "develop" && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_COMMIT_BRANCH == "develop" && $CI_PIPELINE_SOURCE == "web"

  tags:
    - front

deploy prod:
  stage: deploy
  script:
    - docker login -u $ROOT_USER -p $ROOT_USER_TOKEN $CI_REGISTRY
    - docker stack deploy --with-registry-auth --resolve-image=always -c docker-compose.prod.yml $STACK_NAME
  only:
    - master
  tags:
    - front